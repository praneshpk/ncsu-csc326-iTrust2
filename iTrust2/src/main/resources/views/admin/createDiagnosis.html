<html xmlns:th="http://www.thymeleaf.org">
<head th:include="layout :: head(title=~{::title},links=~{})">
<title>Create Diagnosis</title>
</head>
<body th:include="layout :: body" th:with="content=~{::content}">
	<div th:fragment="content">

		<script th:inline="javascript">
			/* Otherwise Thymeleaf tries to parse Javascript as XML and breaks itself sometimes.  Sigh */
			/*<![CDATA[*/

			var app = angular.module('myApp', []);
			app
					.controller(
							'addDiagnosisCtrl',
							function($scope, $http) {
								
								$scope.getDiagnoses = function() {
									$http.get("/iTrust2/api/v1/diagnoses").then(
											function(response) {
												$scope.diagnoses = response.data;
											});
	
									console.log($scope);
								}
								$scope.getDiagnoses();
								$scope.submit = function() {
									$scope.errorMsg = "";
									$scope.hasError = false;
									$scope.hasMessage = false;
									
									if ($scope.diagnosis.name == null) {
										$scope.errorMsg += "Please input a name. \n";
										$scope.hasError = true;
									}
									
									if ($scope.diagnosis.icdCode == null) {
										$scope.errorMsg += "Please input an icd code.\n";
										$scope.hasError = true;
									}
									

									$http({
										method : 'POST',
										url : '/iTrust2/api/v1/creatediagnosis',
										data : $scope.diagnosis
									}).then(function(response) {
										$scope.message="Diagnosis created successfully";
										$scope.hasMessage = true;
										console.log(response);
										$scope.diagnosis.name = "";
										$scope.diagnosis.icdCode = "";
										$scope.getDiagnoses();
									}, function(rejection) {
										$scope.message="Error occurred creating diagnosis";
										console.log(rejection);
										$scope.hasMessage = true;
									})
								}
							});

			/*]]>*/
		</script>



		<div ng-app="myApp" ng-controller="addDiagnosisCtrl as ctrl">
			<h1>Create Diagnosis</h1>
			<div style="float:left;padding: 3%">
				<h3>Add ICD-10 Code</h3>
				<table>
					<tr>
						<td style="text-align:right;padding:5px"><b>Name:</b></td>
						<td><input type="text" name="name" ng-model="diagnosis.name" required="true"/></td>
					</tr>
					<tr>
						<td style="text-align:right;padding:5px"><b>ICD-10 Code:</b></td>
						<td><input type="text" name="name" ng-model="diagnosis.icdCode" required="true"/></td>
					</tr>
				</table>
				
				<br />
				
				<button ng-click="submit()" name="submit">Submit</button>
				
				<div name="errorMsg" ng-show="hasError">{{errorMsg}}</div>

				<div name="success" ng-show="hasMessage">{{message}}</div>
				
				<br />
				<br />
				
				<h3>Current iTrust2 ICD-10 Codes</h3>
				<select style="width: 300px;" size="15">
				    <option  ng-repeat="d in diagnoses" name="diagnosis">{{d.name}} - {{d.icdCode}}</option>
				</select>
				
			</div>

		</div>

	</div>
</body>
</html>